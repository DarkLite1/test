# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

# --------------------------------------
# | DEPLOYMENT GUIDE : node.js web app |
# --------------------------------------

# Set home page in the Azure Web App
# ----------------------------------
# Azure portal > App Services > app > Configuration > Startup command:
# > pm2 serve /home/site/wwwroot --no-daemon
#   (forces to look for index.html instead of landing page)

# Create client secret for GitHub in Azure Portal
# ----------------------------------------------
# Entra AD > App registrations > app > Certificates & secrets > Client secrets
# > Add a new 'Client secret'
#   AZURE_CLIENT_SECRET

# Add Azure login credentials for storage account to GitHub
# ---------------------------------------------------------
# GitHub > Settings > Security > Secrets and variables > Actions > Secrets
# > Add a new 'Repository secret'
#   AZURE_CLIENT_ID
#   AZURE_CLIENT_SECRET
#   AZURE_SUBSCRIPTION_ID
#   AZURE_TENANT_ID

name: Build and deploy Node.js app to Azure Web App - app-emea-we-elearningkioskprod-landing-page-001

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  WEBAPP: app-emea-we-elearningkioskprod-landing-page-001
  GROUP: rg-emea_we_elearningkioskprod-Landing_Page_001
  ACCOUNT: sabelkioskprod001uuguldb
  CONTAINER: temp-web-app-container
  EXPIRY_TIME: 10 minutes
  # AZURE_STORAGE_AUTH_MODE: key

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js version
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: npm install, build, and test
        run: |
          npm install
          npm run build --if-present
          npm run test --if-present

      - name: Zip artifact for deployment
        run: |
          cd ./dist/spa
          zip app.zip ./* -r

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: ./dist/spa/app.zip

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: node-app

      - name: Set SAS token expiration
        run: echo "expiry=`date -u -d "$EXPIRY_TIME" '+%Y-%m-%dT%H:%MZ'`" >> $GITHUB_ENV

      - name: Azure CLI script
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
            az extension add --name webapp --allow-preview true
            az storage container create -n $CONTAINER --account-name $ACCOUNT
            az storage blob upload -f app.zip --account-name $ACCOUNT -c $CONTAINER -n $ACCOUNT
            ZIP_URL=$(az storage blob generate-sas --full-uri --permissions r --expiry ${{ env.expiry }} --account-name $ACCOUNT -c $CONTAINER -n $ACCOUNT | xargs)
            az webapp deploy --name $WEBAPP --resource-group $GROUP --type zip --src-url  $ZIP_URL --async false --clean true
            az storage container delete -n $CONTAINER --account-name $ACCOUNT
